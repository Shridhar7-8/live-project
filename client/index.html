<!--
 Copyright 2025 Google LLC

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->
 
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multimodal Live Chat </title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-color: #6366f1;
      --primary-hover: #5855eb;
      --primary-light: #e0e7ff;
      --secondary-color: #f1f5f9;
      --accent-color: #10b981;
      --danger-color: #ef4444;
      --warning-color: #f59e0b;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border-color: #e2e8f0;
      --background: #ffffff;
      --surface: #f8fafc;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      --radius: 12px;
      --radius-sm: 8px;
      --radius-lg: 16px;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: var(--text-primary);
      line-height: 1.6;
      overflow-x: hidden;
    }

    .main-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .background-pattern {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0.1;
      background-image: 
        radial-gradient(circle at 25% 25%, rgba(255,255,255,0.2) 0%, transparent 50%),
        radial-gradient(circle at 75% 75%, rgba(255,255,255,0.1) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
      text-align: center;
      position: relative;
      z-index: 1;
    }

    .header {
      margin-bottom: 3rem;
      animation: fadeInUp 0.8s ease-out;
    }

    .logo {
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      padding: 0.75rem 1.5rem;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
    }

    h1 {
      font-size: 3.5rem;
      font-weight: 700;
      color: white;
      margin-bottom: 1rem;
      text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      letter-spacing: -0.02em;
    }

    .subtitle {
      font-size: 1.25rem;
      color: rgba(255, 255, 255, 0.9);
      max-width: 600px;
      margin: 0 auto;
      font-weight: 400;
      line-height: 1.7;
    }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2rem;
      position: relative;
      z-index: 1;
    }

    .control-panel {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: var(--radius-lg);
      padding: 2rem;
      box-shadow: var(--shadow-xl);
      border: 1px solid rgba(255, 255, 255, 0.2);
      animation: fadeInUp 0.8s ease-out 0.2s both;
    }

    .input-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      justify-content: center;
      margin-bottom: 2rem;
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .action-button {
      position: relative;
      width: 56px;
      height: 56px;
      border: none;
      border-radius: 50%;
      background: var(--primary-color);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-md);
      overflow: hidden;
    }

    .action-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, rgba(255,255,255,0.1), rgba(255,255,255,0));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .action-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      background: var(--primary-hover);
    }

    .action-button:hover::before {
      opacity: 1;
    }

    .action-button:active {
      transform: translateY(0);
      box-shadow: var(--shadow-md);
    }

    .action-button:disabled {
      background: var(--text-muted);
      cursor: not-allowed;
      transform: none;
      box-shadow: var(--shadow-sm);
    }

    .action-button.recording {
      background: var(--danger-color);
      animation: pulse 2s infinite;
    }

    .action-button.active {
      background: var(--accent-color);
    }

    .text-input-container {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 0.75rem;
      border: 2px solid var(--border-color);
      transition: all 0.3s ease;
      min-width: 300px;
      max-width: 500px;
      flex: 1;
    }

    .text-input-container:focus-within {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .text-input {
      flex: 1;
      border: none;
      outline: none;
      background: transparent;
      font-size: 1rem;
      color: var(--text-primary);
      font-family: inherit;
    }

    .text-input::placeholder {
      color: var(--text-muted);
    }

    .send-button, .interrupt-button {
      width: 40px;
      height: 40px;
      border: none;
      border-radius: var(--radius-sm);
      background: var(--primary-color);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.2s ease;
    }

    .send-button:hover {
      background: var(--primary-hover);
      transform: scale(1.05);
    }

    .interrupt-button {
      background: var(--danger-color);
    }

    .interrupt-button:hover {
      background: #dc2626;
      transform: scale(1.05);
    }

    .video-container {
      display: flex;
      justify-content: center;
      margin: 2rem 0;
      animation: fadeInUp 0.8s ease-out 0.4s both;
    }

    .video-preview {
      max-width: 100%;
      max-height: 400px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      border: 3px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }

    .video-preview:hover {
      transform: scale(1.02);
      box-shadow: var(--shadow-xl);
    }

    .hidden {
      display: none;
    }

    .chat-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: var(--radius-lg);
      padding: 2rem;
      box-shadow: var(--shadow-xl);
      border: 1px solid rgba(255, 255, 255, 0.2);
      max-height: 500px;
      overflow-y: auto;
      animation: fadeInUp 0.8s ease-out 0.6s both;
    }

    .chat-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }

    .chat-icon {
      width: 32px;
      height: 32px;
      background: var(--primary-color);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 16px;
    }

    .chat-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    #output {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    #output p {
      margin: 0;
      padding: 1rem 1.25rem;
      border-radius: var(--radius);
      font-size: 0.95rem;
      line-height: 1.5;
      animation: messageSlideIn 0.3s ease-out;
      position: relative;
      overflow-wrap: break-word;
    }

    .gemini-message {
      background: linear-gradient(135deg, var(--primary-light), #f0f4ff);
      color: var(--text-primary);
      border-left: 4px solid var(--primary-color);
      margin-left: 0;
      margin-right: 2rem;
    }

    .user-message {
      background: linear-gradient(135deg, #f0fdf4, #dcfce7);
      color: var(--text-primary);
      border-left: 4px solid var(--accent-color);
      margin-left: 2rem;
      margin-right: 0;
    }

    .function-name {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      color: var(--text-primary);
      border-left: 4px solid var(--warning-color);
      font-weight: 600;
    }

    .function-params {
      background: var(--surface);
      color: var(--text-secondary);
      border-left: 4px solid var(--text-muted);
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 0.85rem;
      white-space: pre-wrap;
    }

    .api-response {
      background: var(--surface);
      color: var(--text-secondary);
      border-left: 4px solid var(--text-muted);
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 0.85rem;
      white-space: pre-wrap;
    }

    .interrupted-message {
      background: linear-gradient(135deg, #fef2f2, #fee2e2);
      color: var(--danger-color);
      border-left: 4px solid var(--danger-color);
      font-style: italic;
      font-weight: 500;
    }

    .status-indicator {
      position: fixed;
      top: 2rem;
      right: 2rem;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 0.75rem 1.25rem;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      font-weight: 500;
      z-index: 1000;
      transition: all 0.3s ease;
      opacity: 0;
      transform: translateY(-10px);
    }

    .status-indicator.show {
      opacity: 1;
      transform: translateY(0);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-color);
      animation: pulse 2s infinite;
    }

    .floating-particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }

    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      animation: float 6s infinite linear;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes messageSlideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.7;
        transform: scale(1.05);
      }
    }

    @keyframes float {
      from {
        transform: translateY(100vh) rotate(0deg);
        opacity: 0;
      }
      10% {
        opacity: 1;
      }
      90% {
        opacity: 1;
      }
      to {
        transform: translateY(-100px) rotate(360deg);
        opacity: 0;
      }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }

      h1 {
        font-size: 2.5rem;
      }

      .subtitle {
        font-size: 1.1rem;
      }

      .control-panel {
        padding: 1.5rem;
      }

      .input-container {
        flex-direction: column;
        align-items: stretch;
      }

      .action-buttons {
        justify-content: center;
      }

      .text-input-container {
        min-width: auto;
        max-width: none;
      }

      .chat-container {
        padding: 1.5rem;
        max-height: 400px;
      }

      .status-indicator {
        top: 1rem;
        right: 1rem;
        font-size: 0.8rem;
        padding: 0.5rem 1rem;
      }

      .gemini-message, .user-message {
        margin-left: 0;
        margin-right: 0;
      }
    }

    /* Scrollbar Styling */
    .chat-container::-webkit-scrollbar {
      width: 6px;
    }

    .chat-container::-webkit-scrollbar-track {
      background: var(--surface);
      border-radius: 3px;
    }

    .chat-container::-webkit-scrollbar-thumb {
      background: var(--text-muted);
      border-radius: 3px;
    }

    .chat-container::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }

    /* Loading Animation */
    .loading-dots {
      display: inline-flex;
      gap: 4px;
      align-items: center;
    }

    .loading-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--primary-color);
      animation: loadingDots 1.4s infinite ease-in-out;
    }

    .loading-dot:nth-child(1) { animation-delay: -0.32s; }
    .loading-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes loadingDots {
      0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="background-pattern"></div>
    <div class="floating-particles" id="particles"></div>
    
    <div class="status-indicator" id="statusIndicator">
      <div class="status-dot"></div>
      <span id="statusText">Connecting...</span>
    </div>

    <div class="container">
      <div class="header">
        <div class="logo">
          <div class="logo-icon">
            <span class="material-symbols-outlined">electric_bolt</span>
          </div>
          <span style="color: white; font-weight: 600; font-size: 1.1rem;">Multimodal Live Chat</span>
        </div>
        <h1>Multimodal Live Chat</h1>
        <p class="subtitle">Speak into your microphone and optionally share your webcam or screen to engage in a multimedia conversation.</p>
      </div>

      <div class="main-content">
        <div class="control-panel">
          <div class="input-container">
            <div class="action-buttons">
              <button id="micButton" disabled class="action-button" title="Start/Stop Recording">
                <span class="material-symbols-outlined">mic</span>
              </button>
              <button id="webcamButton" class="action-button" title="Toggle Webcam">
                <span class="material-symbols-outlined">videocam</span>
              </button>
              <button id="screenButton" class="action-button" title="Toggle Screen Share">
                <span class="material-symbols-outlined">present_to_all</span>
              </button>
            </div>
            <div class="text-input-container">
              <input type="text" id="textInput" placeholder="Type your message..." class="text-input">
              <button id="sendButton" class="send-button" title="Send Message">
                <span class="material-symbols-outlined">send</span>
              </button>
              <button id="interruptButton" class="interrupt-button" style="display: none;" title="Interrupt">
                <span class="material-symbols-outlined">cancel</span>
              </button>
            </div>
          </div>
        </div>

        <div class="video-container">
          <video id="videoPreview" autoplay playsinline class="video-preview hidden"></video>
        </div>

        <div class="chat-container">
          <div class="chat-header">
            <div class="chat-icon">
              <span class="material-symbols-outlined">chat</span>
            </div>
            <div class="chat-title">Conversation</div>
          </div>
          <div id="output"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Load EventEmitter3 first -->
  <script src="https://cdn.jsdelivr.net/npm/eventemitter3@5.0.1/dist/eventemitter3.umd.min.js"></script>

  <script type="module">
    import { AudioRecorder } from './src/audio/audio-recorder.js';
    import { AudioStreamer } from './src/audio/audio-streamer.js';
    import { MediaHandler } from './src/media/media-handler.js';
    import { GeminiAPI } from './src/api/gemini-api.js';
    import { base64ToArrayBuffer } from './src/utils/utils.js';

    // Initialize components
    const output = document.getElementById('output');
    const audioRecorder = new AudioRecorder();
    const audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 24000 });
    const audioStreamer = new AudioStreamer(audioContext);
    const mediaHandler = new MediaHandler();
    // Dynamic WebSocket endpoint configuration
    function getWebSocketEndpoint() {
      const currentHost = window.location.host;
      const currentProtocol = window.location.protocol;
      
      // If running on Cloud Run (your deployed frontend)
      if (currentHost.includes('livewire-ui') && currentHost.includes('.run.app')) {
        // Use WSS for secure connection to your backend
        return 'wss://livewire-backend-ehm5d5lcmq-uc.a.run.app';
      }
      
      // If running locally
      if (currentHost.includes('localhost') || currentHost.includes('127.0.0.1')) {
        return 'ws://localhost:8081';
      }
      
      // Default fallback
      return 'wss://livewire-backend-ehm5d5lcmq-uc.a.run.app';
    }

    const wsEndpoint = getWebSocketEndpoint();
    console.log('Connecting to WebSocket endpoint:', wsEndpoint);
    const api = new GeminiAPI(wsEndpoint);

    let isRecording = false;
    let hasShownSpeakingMessage = false;
    let currentTurn = 0;
    let lastAudioTurn = -1;

    // Initialize floating particles
    function createParticles() {
      const particlesContainer = document.getElementById('particles');
      for (let i = 0; i < 20; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 6 + 's';
        particle.style.animationDuration = (Math.random() * 3 + 3) + 's';
        particlesContainer.appendChild(particle);
      }
    }

    // Status indicator functions
    function showStatus(text, type = 'info') {
      const indicator = document.getElementById('statusIndicator');
      const statusText = document.getElementById('statusText');
      statusText.textContent = text;
      indicator.classList.add('show');
      
      setTimeout(() => {
        indicator.classList.remove('show');
      }, 3000);
    }

    // Initialize media handler
    mediaHandler.initialize(document.getElementById('videoPreview'));

    // Set up API handlers
    api.onReady = () => {
      document.getElementById('micButton').disabled = false;
      showStatus('Ready to chat!', 'success');
    };

    api.onAudioData = async (audioData) => {
      try {
        if (!api.isSpeaking || lastAudioTurn !== currentTurn) {
          logMessage('Gemini: Speaking...');
          api.isSpeaking = true;
          lastAudioTurn = currentTurn;
          document.getElementById('interruptButton').style.display = 'inline-block';
        }
        const arrayBuffer = base64ToArrayBuffer(audioData);
        audioStreamer.addPCM16(new Uint8Array(arrayBuffer));
        audioStreamer.resume();
      } catch (error) {
        console.error('Error playing audio:', error);
      }
    };

    api.onTextContent = (text) => {
      if (text.trim()) {
        logMessage('Gemini: ' + text);
      }
    };

    api.onTurnComplete = () => {
      logMessage('Gemini: Finished speaking');
      api.isSpeaking = false;  // Reset speaking state
      audioStreamer.complete();
      document.getElementById('interruptButton').style.display = 'none';
    };

    // Add interruption handler
    api.onInterrupted = (data) => {
      logMessage('Gemini: Response interrupted');
      api.isSpeaking = false;
      audioStreamer.stop();  // Stop current playback and clear queue
      document.getElementById('interruptButton').style.display = 'none';
      
      // Show visual feedback for interruption
      const messageElement = document.createElement('p');
      messageElement.className = 'interrupted-message';
      messageElement.textContent = 'Response interrupted by user input';
      output.appendChild(messageElement);
      output.scrollTop = output.scrollHeight;
    };

    // Add function call and response handlers
    api.onFunctionCall = (data) => {
      logMessage('Function: ' + data.name);
      logMessage('Parameters: ' + JSON.stringify(data.args, null, 2));
    };

    api.onFunctionResponse = (data) => {
      logMessage('API Response: ' + JSON.stringify(data, null, 2));
    };

    // UI Event Handlers
    async function startRecording() {
      try {
        // If model is speaking, treat this as an interruption
        if (api.isSpeaking) {
          audioStreamer.stop();
          api.isSpeaking = false;
        }

        await audioContext.resume();
        await audioRecorder.start();
        hasShownSpeakingMessage = false;
        currentTurn++;
        
        audioRecorder.on('data', (base64Data) => {
          if (!hasShownSpeakingMessage) {
            logMessage('You: Speaking...');
            hasShownSpeakingMessage = true;
          }
          api.sendAudioChunk(base64Data);
        });

        isRecording = true;
        const micButton = document.getElementById('micButton');
        micButton.classList.add('recording');
        micButton.innerHTML = '<span class="material-symbols-outlined">stop</span>';
        showStatus('Recording...', 'recording');
      } catch (error) {
        console.error('Error starting recording:', error);
        logMessage('Error: ' + error.message);
        showStatus('Recording failed', 'error');
      }
    }

    function stopRecording() {
      audioRecorder.stop();
      isRecording = false;
      hasShownSpeakingMessage = false;
      const micButton = document.getElementById('micButton');
      micButton.classList.remove('recording');
      micButton.innerHTML = '<span class="material-symbols-outlined">mic</span>';
      logMessage('You: Recording stopped.');
      showStatus('Processing...', 'processing');
      
      // Stop video streams
      mediaHandler.stopAll();
      const webcamButton = document.getElementById('webcamButton');
      const screenButton = document.getElementById('screenButton');
      webcamButton.classList.remove('active');
      screenButton.classList.remove('active');
      webcamButton.innerHTML = '<span class="material-symbols-outlined">videocam</span>';
      screenButton.innerHTML = '<span class="material-symbols-outlined">present_to_all</span>';
      
      api.sendEndMessage();
      api.isSpeaking = false;
    }

    function logMessage(message) {
      const messageElement = document.createElement('p');
      
      // Add specific styling based on message content
      if (message.startsWith('Function:')) {
        messageElement.className = 'function-name';
      } else if (message.startsWith('Parameters:')) {
        messageElement.className = 'function-params';
      } else if (message.startsWith('API Response:')) {
        messageElement.className = 'api-response';
      } else if (message.startsWith('Gemini:')) {
        messageElement.className = 'gemini-message';
      } else if (message.startsWith('You:')) {
        messageElement.className = 'user-message';
      }
      
      messageElement.textContent = message;
      output.appendChild(messageElement);
      output.scrollTop = output.scrollHeight;
    }

    // Add function to send text message
    function sendTextMessage() {
      const textInput = document.getElementById('textInput');
      const text = textInput.value.trim();
      if (!text) return;

      // Clear input
      textInput.value = '';

      // Log user message
      logMessage('You: ' + text);

      // Send text message
      api.sendTextMessage(text);
      showStatus('Message sent', 'success');
    }

    // Set up button click handlers
    document.getElementById('micButton').onclick = () => {
      if (isRecording) {
        stopRecording();
      } else {
        startRecording();
      }
    };

    // Add send button handler
    document.getElementById('sendButton').onclick = sendTextMessage;

    // Add interrupt button handler
    document.getElementById('interruptButton').onclick = () => {
      if (api.isSpeaking) {
        audioStreamer.stop();
        api.isSpeaking = false;
        document.getElementById('interruptButton').style.display = 'none';
        showStatus('Interrupted', 'info');
      }
    };

    // Add keypress handler for text input
    document.getElementById('textInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendTextMessage();
      }
    });

    document.getElementById('webcamButton').onclick = async () => {
      const button = document.getElementById('webcamButton');
      if (mediaHandler.isWebcamActive) {
        mediaHandler.stopAll();
        button.classList.remove('active');
        button.innerHTML = '<span class="material-symbols-outlined">videocam</span>';
        showStatus('Webcam stopped', 'info');
      } else {
        const success = await mediaHandler.startWebcam();
        if (success) {
          button.classList.add('active');
          button.innerHTML = '<span class="material-symbols-outlined">videocam_off</span>';
          mediaHandler.startFrameCapture((base64Image) => {
            api.sendImage(base64Image);
          });
          showStatus('Webcam started', 'success');
        } else {
          showStatus('Webcam failed to start', 'error');
        }
      }
    };

    document.getElementById('screenButton').onclick = async () => {
      const button = document.getElementById('screenButton');
      if (mediaHandler.isScreenActive) {
        mediaHandler.stopAll();
        button.classList.remove('active');
        button.innerHTML = '<span class="material-symbols-outlined">present_to_all</span>';
        showStatus('Screen share stopped', 'info');
      } else {
        const success = await mediaHandler.startScreenShare();
        if (success) {
          button.classList.add('active');
          button.innerHTML = '<span class="material-symbols-outlined">cancel_presentation</span>';
          mediaHandler.startFrameCapture((base64Image) => {
            api.sendImage(base64Image);
          });
          showStatus('Screen share started', 'success');
        } else {
          showStatus('Screen share failed to start', 'error');
        }
      }
    };

    // Initialize particles on load
    createParticles();

    // Show initial status
    showStatus('Initializing...', 'info');
  </script>
</body>
</html>

